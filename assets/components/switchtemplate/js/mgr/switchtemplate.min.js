/*!
 * SwitchTemplate - Switch resource templates on the fly
 * Version: 1.3.2
 * Build date: 2022-06-10
 */
var switchtemplate=function(e){switchtemplate.superclass.constructor.call(this,e=e||{})};Ext.extend(switchtemplate,Ext.Component,{initComponent:function(){this.stores={},this.ajax=new Ext.data.Connection({disableCaching:!0})},page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},util:{},form:{}}),Ext.reg("switchtemplate",switchtemplate),SwitchTemplate=new switchtemplate,MODx.config.help_url="https://jako.github.io/SwitchTemplate/usage/",SwitchTemplate.combo.Type=function(e){e=e||{},Ext.applyIf(e,{store:new Ext.data.ArrayStore({fields:["type","display"],data:[["chunk",_("switchtemplate.type_chunk")],["template",_("switchtemplate.type_template")]]}),mode:"local",displayField:"display",valueField:"type",editable:!1}),SwitchTemplate.combo.Type.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.combo.Type,MODx.combo.ComboBox),Ext.reg("switchtemplate-combo-type",SwitchTemplate.combo.Type),SwitchTemplate.combo.Output=function(e){e=e||{},Ext.applyIf(e,{store:new Ext.data.ArrayStore({fields:["output","display"],data:[["html",_("switchtemplate.output_html")],["amp",_("switchtemplate.output_amp")]]}),mode:"local",displayField:"display",valueField:"output",editable:!1}),SwitchTemplate.combo.Output.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.combo.Output,MODx.combo.ComboBox),Ext.reg("switchtemplate-combo-output",SwitchTemplate.combo.Output),SwitchTemplate.combo.Resources=function(e){var t=new Ext.data.JsonStore({id:"id",root:"results",fields:[{name:"id",type:"int"},{name:"pagetitle",type:"string"}],pageSize:10,url:SwitchTemplate.config.connectorUrl,baseParams:{action:"mgr/resources/getlist"}});e=e||{},Ext.applyIf(e,{pageSize:10,xtype:"superboxselect",store:t,mode:"remote",triggerAction:"all",displayField:"pagetitle",displayFieldTpl:"{pagetitle} ({id})",valueField:"id",lazyRender:!0,editable:!0,typeAhead:!0,minChars:1,forceSelection:!0,extraItemCls:"x-tag",expandBtnCls:"x-form-trigger",clearBtnCls:"x-form-trigger"}),SwitchTemplate.combo.Resources.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.combo.Resources,Ext.ux.form.SuperBoxSelect),Ext.reg("switchtemplate-combo-resources",SwitchTemplate.combo.Resources),SwitchTemplate.util.renderHtml=function(e){return MODx.util.safeHtml(e,"<span>")},SwitchTemplate.panel.Home=function(e){e=e||{},Ext.applyIf(e,{cls:"container home-panel"+(SwitchTemplate.config.debug?" debug":"")+" modx"+SwitchTemplate.config.modxversion,defaults:{collapsible:!1,autoHeight:!0},items:[{html:"<h2>"+_("switchtemplate")+"</h2>"+(SwitchTemplate.config.debug?'<div class="ribbon top-right"><span>'+_("switchtemplate.debug_mode")+"</span></div>":""),border:!1,cls:"modx-page-header"},{defaults:{autoHeight:!0},border:!0,cls:"switchtemplate-panel",items:[{xtype:"switchtemplate-panel-overview"}]},{cls:"treehillstudio_about",html:'<img width="146" height="40" src="'+SwitchTemplate.config.assetsUrl+'img/mgr/treehill-studio-small.png" srcset="'+SwitchTemplate.config.assetsUrl+'img/mgr/treehill-studio-small@2x.png 2x" alt="Treehill Studio">',listeners:{afterrender:function(){this.getEl().select("img").on("click",function(){var e='<span style="display: inline-block; text-align: center"><img src="'+SwitchTemplate.config.assetsUrl+'img/mgr/treehill-studio.png" srcset="'+SwitchTemplate.config.assetsUrl+'img/mgr/treehill-studio@2x.png 2x" alt="Treehill Studio"><br>&copy; 2014-2022 by <a href="https://treehillstudio.com" target="_blank">treehillstudio.com</a></span>';Ext.Msg.show({title:_("switchtemplate")+" "+SwitchTemplate.config.version,msg:e,buttons:Ext.Msg.OK,cls:"treehillstudio_window",width:358})})}}}]}),SwitchTemplate.panel.Home.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.panel.Home,MODx.Panel),Ext.reg("switchtemplate-panel-home",SwitchTemplate.panel.Home),SwitchTemplate.panel.HomeTab=function(e){e=e||{},Ext.applyIf(e,{id:"switchtemplate-panel-"+e.tabtype,title:e.title,items:[{html:"<p>"+e.description+"</p>",border:!1,cls:"panel-desc"},{layout:"form",cls:"x-form-label-left main-wrapper",defaults:{autoHeight:!0},border:!0,items:[{id:"switchtemplate-panel-"+e.tabtype+"-grid",xtype:"switchtemplate-grid-"+e.tabtype,preventRender:!0}]}]}),SwitchTemplate.panel.HomeTab.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.panel.HomeTab,MODx.Panel),Ext.reg("switchtemplate-panel-hometab",SwitchTemplate.panel.HomeTab),SwitchTemplate.panel.Overview=function(e){e=e||{},this.ident="switchtemplate-panel-overview-"+Ext.id(),this.panelOverviewTabs=[{xtype:"switchtemplate-panel-hometab",title:_("switchtemplate.setting"),description:_("switchtemplate.setting_desc"),tabtype:"setting"}],SwitchTemplate.config.is_admin&&this.panelOverviewTabs.push({xtype:"switchtemplate-panel-settings"}),Ext.applyIf(e,{id:this.ident,items:[{xtype:"modx-tabs",border:!0,stateful:!0,stateId:"switchtemplate-panel-overview",stateEvents:["tabchange"],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())}},autoScroll:!0,deferredRender:!1,forceLayout:!0,defaults:{layout:"form",autoHeight:!0,hideMode:"offsets"},items:this.panelOverviewTabs,listeners:{tabchange:function(e,t){"switchtemplate-panel-settings"===t.xtype?Ext.getCmp("switchtemplate-grid-system-settings").getStore().reload():"switchtemplate-panel-hometab"===t.xtype&&Ext.getCmp("switchtemplate-panel-"+t.tabtype+"-grid")&&Ext.getCmp("switchtemplate-panel-"+t.tabtype+"-grid").getStore().reload()}}}]}),SwitchTemplate.panel.Overview.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.panel.Overview,MODx.Panel),Ext.reg("switchtemplate-panel-overview",SwitchTemplate.panel.Overview),SwitchTemplate.grid.Setting=function(e){e=e||{},this.ident="switchtemplate-grid-setting-"+Ext.id(),this.buttonColumnTpl=new Ext.XTemplate('<tpl for="."><tpl if="action_buttons !== null"><ul class="action-buttons"><tpl for="action_buttons"><li><i class="icon {className} icon-{icon}" title="{text}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0}),Ext.applyIf(e,{id:"switchtemplate-grid-setting",url:SwitchTemplate.config.connectorUrl,baseParams:{action:"mgr/setting/getlist",pageSize:10},fields:["id","name","key","extension","template","templatename","type","output","cache","include","exclude"],autoHeight:!0,paging:!0,remoteSort:!0,autoExpandColumn:"name",showActionsColumn:!1,columns:[{header:_("switchtemplate.setting_name"),dataIndex:"name",sortable:!0,width:100},{header:_("switchtemplate.setting_key"),dataIndex:"key",sortable:!0,width:50},{header:_("switchtemplate.setting_templatename"),dataIndex:"templatename",renderer:SwitchTemplate.util.renderHtml,sortable:!0,width:120},{header:_("switchtemplate.setting_extension"),dataIndex:"extension",sortable:!0,width:50},{header:_("switchtemplate.setting_type_short"),dataIndex:"type",sortable:!0,renderer:function(e){return _("switchtemplate.type_"+e)},width:40},{header:_("switchtemplate.setting_output_short"),dataIndex:"output",sortable:!0,renderer:function(e){return _("switchtemplate.output_"+e)},width:40},{header:_("switchtemplate.setting_cache_short"),dataIndex:"cache",sortable:!0,editable:!1,width:40,editor:{xtype:"combo-boolean",renderer:"boolean"}},{header:_("id"),dataIndex:"id",sortable:!0,hidden:!0},{renderer:{fn:this.buttonColumnRenderer,scope:this},menuDisabled:!0,width:40}],tbar:[{text:_("switchtemplate.setting_create"),cls:"primary-button",handler:this.createSetting},"->",{xtype:"textfield",id:this.ident+"-setting-filter-search",emptyText:_("search")+"â€¦",submitValue:!1,listeners:{change:{fn:this.search,scope:this},render:{fn:function(e){new Ext.KeyMap(e.getEl(),{key:Ext.EventObject.ENTER,fn:function(){return this.fireEvent("change",this),this.blur(),!0},scope:e})},scope:this}}},{xtype:"button",id:this.ident+"-setting-filter-clear",cls:"x-form-filter-clear",text:_("filter_clear"),listeners:{click:{fn:this.clearFilter,scope:this}}}]}),SwitchTemplate.grid.Setting.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.grid.Setting,MODx.grid.Grid,{windows:{},getMenu:function(){var e=[];e.push({text:_("switchtemplate.setting_update"),handler:this.updateSetting}),e.push("-"),e.push({text:_("switchtemplate.setting_remove"),handler:this.removeSetting}),this.addContextMenuItem(e)},createSetting:function(e,t){this.createUpdateSetting(e,t,!1)},updateSetting:function(e,t){this.createUpdateSetting(e,t,!0)},createUpdateSetting:function(e,t,i){var a;if(i){if(!this.menu.record||!this.menu.record.id)return!1;a=this.menu.record}else a={};i=MODx.load({xtype:"switchtemplate-window-setting-create-update",isUpdate:i,title:i?_("switchtemplate.setting_update"):_("switchtemplate.setting_ceate"),record:a,listeners:{success:{fn:this.refresh,scope:this},beforeSubmit:function(){var i=this.fp.getForm();i.items.each(function(e){var t;"switchtemplate-combo-resources"!==e.xtype||(t=i.findField(e.name+"Data"))&&t.setValue(e.getValue())})}}});i.fp.getForm().setValues(a),i.show(t.target)},removeSetting:function(){if(!this.menu.record)return!1;MODx.msg.confirm({title:_("switchtemplate.setting_remove"),text:_("switchtemplate.setting_remove_confirm"),url:this.config.url,params:{action:"mgr/setting/remove",id:this.menu.record.id},listeners:{success:{fn:this.refresh,scope:this}}})},search:function(e){this.getStore().baseParams.query=e.getValue(),this.getBottomToolbar().changePage(1),this.refresh()},clearFilter:function(){this.getStore().baseParams.query="",Ext.getCmp(this.ident+"-setting-filter-search").reset(),this.getBottomToolbar().changePage(1),this.refresh()},buttonColumnRenderer:function(){var e={action_buttons:[{className:"update",icon:"pencil-square-o",text:_("switchtemplate.setting_update")},{className:"remove",icon:"trash-o",text:_("switchtemplate.setting_remove")}]};return this.buttonColumnTpl.apply(e)},onClick:function(e){var t=e.getTarget();if("icon"===t.className.split(" ")[0]){var t=t.className.split(" ")[1],i=this.getSelectionModel().getSelected();switch(this.menu.record=i.data,t){case"remove":this.removeSetting(i,e);break;case"update":this.updateSetting(i,e)}}}}),Ext.reg("switchtemplate-grid-setting",SwitchTemplate.grid.Setting),SwitchTemplate.window.CreateUpdateSetting=function(e){e=e||{},this.ident="switchtemplate-setting-create-update-"+Ext.id(),Ext.applyIf(e,{id:this.ident,url:SwitchTemplate.config.connectorUrl,action:e.isUpdate?"mgr/setting/update":"mgr/setting/create",autoHeight:!0,closeAction:"close",cls:"modx-window customrequest-window modx"+SwitchTemplate.config.modxversion,width:700,fields:[{layout:"column",items:[{columnWidth:.33,layout:"form",items:[{xtype:"textfield",fieldLabel:_("switchtemplate.setting_name"),name:"name",id:this.ident+"-name",anchor:"100%",allowBlank:!1}]},{columnWidth:.33,layout:"form",items:[{xtype:"textfield",fieldLabel:_("switchtemplate.setting_key"),name:"key",id:this.ident+"-key",anchor:"100%",allowBlank:!1}]},{columnWidth:.34,layout:"form",items:[{xtype:"textfield",fieldLabel:_("switchtemplate.setting_extension"),name:"extension",id:this.ident+"-extension",anchor:"100%"}]}]},{layout:"column",items:[{columnWidth:.4,layout:"form",items:[{xtype:"textfield",fieldLabel:_("switchtemplate.setting_templatename"),name:"template",id:this.ident+"-template",anchor:"100%"}]},{columnWidth:.2,layout:"form",items:[{xtype:"switchtemplate-combo-type",fieldLabel:_("switchtemplate.setting_type"),value:"chunk",name:"type",hiddenName:"type",id:this.ident+"-type",anchor:"100%",allowBlank:!1}]},{columnWidth:.2,layout:"form",items:[{xtype:"modx-combo-boolean",fieldLabel:_("switchtemplate.setting_cache"),value:"1",name:"cache",hiddenName:"cache",id:this.ident+"-cache",anchor:"100%"}]},{columnWidth:.2,layout:"form",items:[{xtype:"switchtemplate-combo-output",fieldLabel:_("switchtemplate.setting_output"),value:"html",name:"output",hiddenName:"output",id:this.ident+"-output",anchor:"100%"}]}]},{layout:"column",items:[{columnWidth:.5,layout:"form",items:[{xtype:"switchtemplate-combo-resources",fieldLabel:_("switchtemplate.setting_include"),description:MODx.expandHelp?"":_("switchtemplate.setting_include_desc"),name:"include",hiddenName:"include",id:this.ident+"-include",anchor:"100%"},{xtype:MODx.expandHelp?"label":"hidden",forId:this.ident+"-template",html:_("switchtemplate.setting_include_desc"),cls:"desc-under"},{xtype:"textfield",name:"includeData",id:this.ident+"-includeData",hidden:!0}]},{columnWidth:.5,layout:"form",items:[{xtype:"switchtemplate-combo-resources",fieldLabel:_("switchtemplate.setting_exclude"),description:MODx.expandHelp?"":_("switchtemplate.setting_exclude_desc"),name:"exclude",hiddenName:"exclude",id:this.ident+"-exclude",anchor:"100%"},{xtype:MODx.expandHelp?"label":"hidden",forId:this.ident+"-template",html:_("switchtemplate.setting_exclude_desc"),cls:"desc-under"},{xtype:"textfield",name:"excludeData",id:this.ident+"-excludeData",hidden:!0}]}]},{xtype:"hidden",name:"id",id:this.ident+"-id"}]}),SwitchTemplate.window.CreateUpdateSetting.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.window.CreateUpdateSetting,MODx.Window),Ext.reg("switchtemplate-window-setting-create-update",SwitchTemplate.window.CreateUpdateSetting),SwitchTemplate.panel.Settings=function(e){e=e||{},Ext.applyIf(e,{id:"switchtemplate-panel-settings",title:_("switchtemplate.settings"),items:[{html:"<p>"+_("switchtemplate.settings_desc")+"</p>",border:!1,cls:"panel-desc"},{xtype:"switchtemplate-grid-system-settings",id:"switchtemplate-grid-system-settings",cls:"main-wrapper",preventSaveRefresh:!0}]}),SwitchTemplate.panel.Settings.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.panel.Settings,MODx.Panel),Ext.reg("switchtemplate-panel-settings",SwitchTemplate.panel.Settings),SwitchTemplate.grid.SystemSettings=function(e){e=e||{},Ext.applyIf(e,{id:"switchtemplate-grid-systemsettings",url:SwitchTemplate.config.connectorUrl,baseParams:{action:"mgr/settings/getlist",area:MODx.request.area||""},save_action:"mgr/settings/updatefromgrid",tbar:[],queryParam:3<=SwitchTemplate.config.modxversion?"query":"key"}),SwitchTemplate.grid.SystemSettings.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.grid.SystemSettings,MODx.grid.SettingsGrid,{_showMenu:function(e,t,i){i.stopEvent(),i.preventDefault(),this.menu.record=this.getStore().getAt(t).data,this.getSelectionModel().isSelected(t)||this.getSelectionModel().selectRow(t),this.menu.removeAll();t=[];this.menu.record.menu?t=this.menu.record.menu:t.push({text:_("setting_update")||_("edit"),handler:this.updateSetting}),0<t.length&&(this.addContextMenuItem(t),this.menu.showAt(i.xy))},updateSetting:function(e,t){var i=this.menu.record,a=(i.fk=Ext.isDefined(this.config.fk)?this.config.fk:0,MODx.load({xtype:"modx-window-setting-update",url:SwitchTemplate.config.connectorUrl,action:"mgr/settings/update",record:i,grid:this,listeners:{success:{fn:function(){this.refresh()},scope:this}}}));a.reset(),a.setValues(i),a.show(t.target)},clearFilter:function(){var e=MODx.request.area||"",t=(this.getStore().baseParams=this.initialConfig.baseParams,Ext.getCmp("modx-filter-area"));t&&(t.store.load(),t.reset()),Ext.getCmp("modx-filter-"+this.config.queryParam).reset(),this.getStore().baseParams.area=e,this.getStore().baseParams[this.config.queryParam]="",this.getBottomToolbar().changePage(1)},filterByKey:function(e,t){return this.getStore().baseParams[this.config.queryParam]=t,this.getBottomToolbar().changePage(1),!0},filterByNamespace:function(){this.getStore().baseParams.area="",this.getBottomToolbar().changePage(1);var e,t=Ext.getCmp("modx-filter-area");t&&((e=t.store).removeAll(),e.load(),t.setValue(""))},listeners:{afterrender:function(){Ext.getCmp("modx-filter-namespace").hide()}}}),Ext.reg("switchtemplate-grid-system-settings",SwitchTemplate.grid.SystemSettings),SwitchTemplate.page.Home=function(e){e=e||{},Ext.applyIf(e,{buttons:[{text:_("help_ex"),handler:MODx.loadHelpPane}],formpanel:"switchtemplate-panel-home",components:[{xtype:"switchtemplate-panel-home"}]}),SwitchTemplate.page.Home.superclass.constructor.call(this,e)},Ext.extend(SwitchTemplate.page.Home,MODx.Component),Ext.reg("switchtemplate-page-home",SwitchTemplate.page.Home);